<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whack-a-Mole</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Log all Firestore debug messages to the console
        setLogLevel('debug');

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            limit,
            serverTimestamp
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            padding: 2rem;
            box-sizing: border-box;
        }

        .game-container {
            background-color: #2d3748;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #48bb78;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.25rem;
            color: #a0aec0;
            margin-bottom: 2rem;
        }

        .game-board {
            position: relative;
            background-image: url('https://placehold.co/600x600/4a5568/a0aec0?text=Whack-a-Mole+Board');
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            width: 100%;
            padding-bottom: 100%; /* Creates a square aspect ratio */
            margin-bottom: 2rem;
            overflow: hidden;
            border: 4px solid #48bb78;
        }

        .mole {
            position: absolute;
            width: 10%;
            height: 10%;
            background-color: #48bb78;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s ease-out;
            box-shadow: 0 4px #38a169;
        }

        .mole:hover {
            transform: scale(1.1);
        }

        .mole.hit {
            background-color: #f56565;
            box-shadow: 0 4px #e53e3e;
            animation: hit-pulse 0.2s ease-out;
        }

        @keyframes hit-pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        .status-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0.5rem;
            flex-grow: 1;
        }

        .button-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            outline: none;
            box-shadow: 0 4px #3182ce;
        }

        .btn:hover {
            background-color: #3182ce;
        }

        .btn:active {
            box-shadow: none;
            transform: translateY(2px);
        }

        .btn-green {
            background-color: #48bb78;
            box-shadow: 0 4px #38a169;
        }
        
        .btn-green:hover {
            background-color: #38a169;
        }
        
        .btn-green:active {
            box-shadow: none;
            transform: translateY(2px);
        }

        .btn-red {
            background-color: #e53e3e;
            box-shadow: 0 4px #c53030;
        }
        
        .btn-red:hover {
            background-color: #c53030;
        }

        .message {
            margin-top: 1rem;
            font-size: 1.25rem;
            min-height: 1.5rem;
        }
        
        .high-scores {
            margin-top: 2rem;
            text-align: left;
            border-top: 2px solid #48bb78;
            padding-top: 1rem;
        }
        
        .high-scores ol {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .high-scores li {
            background-color: #4a5568;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        .collapsible-header {
            cursor: pointer;
            text-decoration: underline;
            color: #4299e1;
            font-weight: bold;
            margin-top: 1rem;
        }
        .collapsible-content {
            display: none;
            text-align: left;
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        .collapsible-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="title">Whack-a-Mole</h1>
        <p class="subtitle">Click the green circle to score points!</p>
        
        <div class="controls">
            <label for="difficulty-select" class="text-sm font-semibold">Initial Difficulty:</label>
            <select id="difficulty-select" class="p-2 rounded-lg bg-gray-700 text-white border-none outline-none">
                <option value="easy">Easy</option>
                <option value="normal">Normal</option>
                <option value="hard">Hard</option>
            </select>
        </div>

        <div class="status-area">
            <div class="status-item"><span>Time:</span> <span id="time">0</span>s</div>
            <div class="status-item"><span>Score:</span> <span id="score">0</span></div>
            <div class="status-item"><span>Level:</span> <span id="level">1</span></div>
        </div>
        <p class="text-xs text-gray-400 mb-2">User ID: <span id="user-id"></span></p>

        <div class="game-board" id="game-board"></div>
        <div class="button-area">
            <div class="flex gap-4">
                <button id="start-btn" class="btn btn-green">Start</button>
                <button id="pause-btn" class="btn" disabled>Pause</button>
                <button id="stop-btn" class="btn btn-red" disabled>Stop</button>
            </div>
            <button id="restart-btn" class="btn" disabled>Restart</button>
        </div>
        <p id="message" class="message"></p>
        
        <div class="high-scores">
            <h2 class="text-xl font-bold mb-2">High Scores</h2>
            <ol id="high-score-list"></ol>
        </div>

        <div class="collapsible-header" id="how-to-play-header">How to Play & Features</div>
        <div class="collapsible-content" id="how-to-play-content">
            <h3 class="font-bold text-lg mb-2">Objective</h3>
            <p>Click on the green moles as they pop up to earn points. Be quick, or you'll lose points!</p>
            <h3 class="font-bold text-lg mt-4 mb-2">Levels & Rewards</h3>
            <p>The game has 50 levels. Each time you reach a new level, moles appear faster and you earn more points for each hit. Missing a mole will penalize your score. The penalty is higher on more difficult levels!</p>
            <h3 class="font-bold text-lg mt-4 mb-2">Features</h3>
            <ul class="list-disc list-inside">
                <li>**Real-time Leaderboard:** Compete with other players globally with a live high score board.</li>
                <li>**Adjustable Difficulty:** Choose an initial difficulty to set your starting pace.</li>
                <li>**Dynamic Feedback:** Get instant on-screen messages and sound effects for hits and misses.</li>
                <li>**Full Controls:** Use the Start/Pause/Stop/Restart buttons to manage your game session.</li>
            </ul>
        </div>
    </div>

    <div id="custom-message-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border-2 border-gray-600 rounded-2xl p-8 text-center z-50 backdrop-blur-sm hidden">
        <p id="custom-message-text" class="text-white text-xl font-semibold mb-4"></p>
        <button id="custom-message-ok" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">OK</button>
    </div>

    <script type="module">
        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Corrected Firebase authentication token variable name
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Setup ---
        let db, auth, userId;
        
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, limit, serverTimestamp } = window.firebase;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Listen for auth state changes and initialize the game
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // Truncate the user ID for display
                    document.getElementById('user-id').textContent = userId.substring(0, 8) + '...';
                    fetchHighScores();
                } else {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showMessageBox("Failed to initialize Firebase. Please check the console for details.");
        }
        
        // Helper function for the custom message box
        function showMessageBox(message) {
            const messageBox = document.getElementById('custom-message-box');
            const messageText = document.getElementById('custom-message-text');
            const okButton = document.getElementById('custom-message-ok');
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            return new Promise(resolve => {
                okButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    resolve();
                };
            });
        }
        
        // --- Audio Setup with Tone.js ---
        const synth = new Tone.Synth().toDestination();
        const hitSynth = new Tone.MembraneSynth().toDestination();
        const missSynth = new Tone.NoiseSynth({
            noise: { type: 'pink' },
            envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.2 }
        }).toDestination();

        let backgroundLoop;

        function startMusic() {
            if (backgroundLoop) return;
            Tone.context.resume();
            backgroundLoop = new Tone.Loop(time => {
                synth.triggerAttackRelease("C4", "8n", time);
                synth.triggerAttackRelease("E4", "8n", time + 0.5);
                synth.triggerAttackRelease("G4", "8n", time + 1);
            }, "1m").start(0);
            Tone.Transport.start();
        }

        function stopMusic() {
            if (backgroundLoop) {
                backgroundLoop.stop();
                backgroundLoop = null;
            }
            Tone.Transport.stop();
        }
        
        // --- Game State and DOM Elements ---
        let score = 0;
        let gameTime = 30; // 30 seconds
        let isGameRunning = false;
        let isPaused = false;
        let gameInterval;
        let moleTimeout;
        let timeRemaining = gameTime;
        let currentLevel = 1;

        const scoreEl = document.getElementById('score');
        const timeEl = document.getElementById('time');
        const levelEl = document.getElementById('level');
        const messageEl = document.getElementById('message');
        const gameBoard = document.getElementById('game-board');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const restartBtn = document.getElementById('restart-btn');
        const difficultySelect = document.getElementById('difficulty-select');
        const highScoreList = document.getElementById('high-score-list');
        const howToPlayHeader = document.getElementById('how-to-play-header');
        const howToPlayContent = document.getElementById('how-to-play-content');
        
        // Difficulty settings and level progression
        const levelData = {
            easy: { moleAppearanceDelay: 1500, moleDisplayTime: 1000, hitPoints: 1, missPenalty: 0 },
            normal: { moleAppearanceDelay: 1000, moleDisplayTime: 800, hitPoints: 1, missPenalty: 1 },
            hard: { moleAppearanceDelay: 500, moleDisplayTime: 600, hitPoints: 2, missPenalty: 2 }
        };

        const levelUpThreshold = 5; // Score needed to level up
        let nextLevelScoreThreshold = levelUpThreshold;

        // --- Game Logic ---
        function startGame() {
            if (isGameRunning && !isPaused) {
                pauseGame();
                return;
            }
            
            if (isPaused) {
                isPaused = false;
                messageEl.textContent = 'Game Resumed!';
                gameInterval = setInterval(updateTimer, 1000);
                startMusic();
                createMole();
            } else {
                isGameRunning = true;
                score = 0;
                currentLevel = 1;
                nextLevelScoreThreshold = levelUpThreshold;
                scoreEl.textContent = score;
                levelEl.textContent = currentLevel;
                messageEl.textContent = 'Game Started!';
                gameBoard.innerHTML = '';
                timeRemaining = gameTime;
                timeEl.textContent = timeRemaining;
                
                gameInterval = setInterval(updateTimer, 1000);
                startMusic();
                createMole();
            }

            // Button state management
            startBtn.textContent = 'Pause';
            startBtn.classList.remove('btn-green');
            startBtn.classList.add('btn');
            pauseBtn.disabled = false;
            stopBtn.disabled = false;
            restartBtn.disabled = true;
        }

        function pauseGame() {
            isPaused = true;
            clearInterval(gameInterval);
            clearTimeout(moleTimeout);
            gameBoard.innerHTML = ''; // Hide the mole
            messageEl.textContent = 'Game Paused.';
            startBtn.textContent = 'Resume';
            startBtn.classList.remove('btn');
            startBtn.classList.add('btn-green');
            stopMusic();
        }

        function stopGame() {
            endGame();
            messageEl.textContent = 'Game Stopped. Press Start to play again.';
            startBtn.disabled = false;
            restartBtn.disabled = false;
        }

        function endGame() {
            isGameRunning = false;
            isPaused = false;
            clearInterval(gameInterval);
            clearTimeout(moleTimeout);
            gameBoard.innerHTML = '';
            messageEl.textContent = `Game Over! Your final score is ${score}.`;
            stopMusic();
            saveScore(score);

            // Reset UI for end of game
            startBtn.textContent = 'Start';
            startBtn.classList.remove('btn');
            startBtn.classList.add('btn-green');
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            restartBtn.disabled = false;
            timeRemaining = gameTime;
            timeEl.textContent = timeRemaining;
        }

        function restartGame() {
            // Reset all state to initial values
            isGameRunning = false;
            isPaused = false;
            score = 0;
            currentLevel = 1;
            nextLevelScoreThreshold = levelUpThreshold;
            timeRemaining = gameTime;
            clearInterval(gameInterval);
            clearTimeout(moleTimeout);
            
            // Reset UI
            scoreEl.textContent = score;
            levelEl.textContent = currentLevel;
            timeEl.textContent = timeRemaining;
            gameBoard.innerHTML = '';
            messageEl.textContent = 'Ready to start a new game!';
            
            // Reset buttons
            startBtn.textContent = 'Start';
            startBtn.classList.remove('btn');
            startBtn.classList.add('btn-green');
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            restartBtn.disabled = true;
        }

        function updateTimer() {
            timeRemaining--;
            timeEl.textContent = timeRemaining;
            if (timeRemaining <= 0) {
                endGame();
            }
            
            if (score >= nextLevelScoreThreshold && currentLevel < 50) {
                levelUp();
            }
        }

        function levelUp() {
            currentLevel++;
            nextLevelScoreThreshold += levelUpThreshold * currentLevel;
            levelEl.textContent = currentLevel;
            messageEl.textContent = `Level Up! Now at Level ${currentLevel}!`;
        }

        function getMoleConfig() {
            const initialDifficulty = difficultySelect.value;
            const baseConfig = levelData[initialDifficulty];
            
            // Adjust mole speed and points based on level
            const moleAppearanceDelay = Math.max(200, baseConfig.moleAppearanceDelay - (currentLevel - 1) * 20);
            const moleDisplayTime = Math.max(200, baseConfig.moleDisplayTime - (currentLevel - 1) * 10);
            const hitPoints = baseConfig.hitPoints + Math.floor((currentLevel - 1) / 5);
            const missPenalty = baseConfig.missPenalty + Math.floor((currentLevel - 1) / 10);
            
            return { moleAppearanceDelay, moleDisplayTime, hitPoints, missPenalty };
        }

        function createMole() {
            if (!isGameRunning || isPaused) {
                clearTimeout(moleTimeout);
                return;
            }

            // Clear existing mole and its timeout
            gameBoard.innerHTML = '';
            clearTimeout(moleTimeout);

            const { moleDisplayTime, moleAppearanceDelay, hitPoints, missPenalty } = getMoleConfig();

            const mole = document.createElement('div');
            mole.classList.add('mole');
            
            const boardSize = gameBoard.getBoundingClientRect();
            const moleSize = boardSize.width * 0.1;
            
            const maxX = boardSize.width - moleSize;
            const maxY = boardSize.height - moleSize;
            
            const randomX = Math.random() * maxX;
            const randomY = Math.random() * maxY;
            
            mole.style.left = `${randomX}px`;
            mole.style.top = `${randomY}px`;
            
            mole.addEventListener('click', (e) => {
                e.stopPropagation();
                if (isGameRunning && !isPaused) {
                    score += hitPoints;
                    scoreEl.textContent = score;
                    mole.classList.add('hit');
                    hitSynth.triggerAttackRelease("C2", "8n");
                    messageEl.textContent = `Hit! (+${hitPoints})`;
                    // A hit immediately creates a new mole
                    clearTimeout(moleTimeout);
                    moleTimeout = setTimeout(createMole, moleAppearanceDelay);
                }
            });

            gameBoard.appendChild(mole);

            // Set a timeout for the mole to disappear if not hit
            moleTimeout = setTimeout(() => {
                if(isGameRunning && !isPaused) {
                    score = Math.max(0, score - missPenalty);
                    scoreEl.textContent = score;
                    missSynth.triggerAttackRelease("8n");
                    messageEl.textContent = "Miss!";
                    createMole(); // Create a new mole
                }
            }, moleDisplayTime);
        }

        gameBoard.addEventListener('click', (e) => {
            if (isGameRunning && !isPaused && !e.target.classList.contains('mole')) {
                const { missPenalty } = getMoleConfig();
                score = Math.max(0, score - missPenalty);
                scoreEl.textContent = score;
                missSynth.triggerAttackRelease("8n");
                messageEl.textContent = "Miss!";
            }
        });

        // --- Firestore High Score Logic ---
        async function saveScore(finalScore) {
            if (!db || !userId) return;
            const scoresRef = collection(db, `/artifacts/${appId}/public/data/scores`);
            try {
                await addDoc(scoresRef, {
                    userId: userId,
                    score: finalScore,
                    timestamp: serverTimestamp(),
                });
                console.log("Score saved successfully!");
            } catch (e) {
                console.error("Error saving score:", e);
                showMessageBox("Failed to save score. Check the console for details.");
            }
        }

        function fetchHighScores() {
            if (!db) return;
            const scoresRef = collection(db, `/artifacts/${appId}/public/data/scores`);
            // Limit to top 10 scores
            const q = query(scoresRef, limit(10));
            
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    scores.push(data);
                });
                scores.sort((a, b) => b.score - a.score);
                renderHighScores(scores);
            }, (error) => {
                console.error("Error fetching high scores:", error);
            });
        }

        function renderHighScores(scores) {
            highScoreList.innerHTML = '';
            if (scores.length === 0) {
                highScoreList.innerHTML = '<li class="text-gray-400">No scores yet. Be the first!</li>';
                return;
            }
            scores.forEach((s, index) => {
                const li = document.createElement('li');
                // Truncate the user ID for display on the leaderboard
                const displayUserId = s.userId ? s.userId.substring(0, 8) + '...' : 'Anonymous';
                li.innerHTML = `<span>#${index + 1} User: ${displayUserId}</span><span>${s.score}</span>`;
                highScoreList.appendChild(li);
            });
        }
        
        // Event listeners for buttons
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', pauseGame);
        stopBtn.addEventListener('click', stopGame);
        restartBtn.addEventListener('click', restartGame);

        // How to Play collapsible
        howToPlayHeader.addEventListener('click', () => {
            howToPlayContent.classList.toggle('active');
        });
        
        // Initial call on window load
        window.onload = function() {
            console.log('Game loaded. Press "Start Game" to begin.');
        };
    </script>
</body>
</html>
